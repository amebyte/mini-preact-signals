<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Preact Signals</title>
</head>
<body>
   <script>
let currentTarget = undefined

function addTargetToAllSources(target) {
	for (let node = target._sources; node; node = node.nextSignal) {
		node.signal._subscribe(node);
	}
}

class Signal {
    _value
    _currentTarget = undefined
    _targets = undefined
    constructor(value) {
        this._value = value
    }

    _subscribe(node) {
		if (this._targets) {
			this._targets.prevTarget = node;
		}
		node.nextTarget = this._targets;
		node.prevTarget = undefined;
		this._targets = node;
	}

    get value() {
        let node = undefined
        console.log('依赖收集')
        // 依赖收集
        if (currentTarget !== void 0) {
            node = { signal: this, target: currentTarget}
            this._currentTarget = node
        }
        if (currentTarget && node) {
            node.nextSignal = currentTarget._sources;
            currentTarget._sources = node;
        }
        return this._value
    }

    set value(value) {
        if (this._value !== value) {
            this._value = value
            console.log('this._targets', this._targets)
			for (let node = this._targets; node; node = node.nextTarget) {
				console.log('node', node)
                node.target._callback()
			}
        }
    }
}

function signal(value) {
    return new Signal(value)
}

class Effect {
    _callback
    constructor(_callback) {
        this._callback = _callback
    }

    _run() {
		const prevContext = currentTarget;
		try {
			currentTarget = this;
			this._callback();
		} finally {
            addTargetToAllSources(this)
			currentTarget = prevContext;
		}
	}

}

function effect(callback) {
    const effect = new Effect(callback);
	effect._run();
}

const a = signal("a")
effect(() => {
    console.log('effect1', a.value)
})
effect(() => {
    console.log('effect2', a.value)
})
a.value = 'aa'
   </script> 
</body>
</html>